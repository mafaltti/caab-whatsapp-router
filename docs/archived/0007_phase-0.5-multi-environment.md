# Phase 0.5 — Multi-Environment Supabase Setup

## Context

Phase 0 (project bootstrap) is complete — Next.js 15.3, TypeScript, Supabase CLI init, health endpoint, webhook stub, and GitHub Actions workflows all exist but are untracked in git. Phase 0.5 establishes the multi-environment CI/CD pipeline so that when Phase 1 creates the first database migration, infrastructure to test and deploy it is ready.

The GitHub Actions workflows already exist but have issues that need fixing before they'll work reliably in CI.

---

## Plan

### Step 1: Delete stale `nul` file

- **File:** `nul` (project root)
- A Windows artifact accidentally created. Delete it and add `nul` to `.gitignore` to prevent recurrence.

### Step 2: Fix CI workflow (`ci.yml`)

**File:** `.github/workflows/ci.yml`

**Changes:**

- Replace `supabase start` with `supabase db start` — only starts PostgreSQL (much faster in CI, official recommendation)
- Add `workflow_dispatch:` trigger for manual runs
- Add `git diff` output before exit for easier debugging

### Step 3: Improve staging workflow (`staging.yml`)

**File:** `.github/workflows/staging.yml`

**Changes:**

- Add `workflow_dispatch:` trigger
- Add concurrency group (`cancel-in-progress: false`) to prevent parallel migration deployments
- Add `SUPABASE_PROJECT_ID` env var (aligns with official Supabase pattern)

### Step 4: Improve production workflow (`production.yml`)

**File:** `.github/workflows/production.yml`

Same changes as staging, with production secrets.

### Step 5: Generate baseline `src/lib/db/types.ts`

The CI validates that committed types match the schema. A baseline file must exist. With no migrations, it will contain only Supabase internal schemas (`auth`, `storage`).

```bash
supabase db start        # locally
supabase gen types typescript --local > src/lib/db/types.ts
```

This replaces the `.gitkeep` in `src/lib/db/`.

### Step 6: Commit Phase 0 + Phase 0.5 on `main`

**Commit 1 — Phase 0 files** (all currently untracked):

- `package.json`, `package-lock.json`, `tsconfig.json`, `next.config.ts`, `next-env.d.ts`
- `eslint.config.mjs`, `.env.example`, `.gitignore` (updated)
- `src/` (all app code, lib dirs with `.gitkeep`, generated types)
- `supabase/config.toml`
- `docs/` (`PLAN.md`, `ARCHITECTURE.md`, `ENVIRONMENT.md`, `FLOWS.md`, `archived/`)
- Handle deleted root docs (moved to `docs/`)

**Commit 2 — Phase 0.5 workflow improvements:**

- Updated `.github/workflows/ci.yml`
- Updated `.github/workflows/staging.yml`
- Updated `.github/workflows/production.yml`

### Step 7: Create `develop` branch and push

```bash
git push -u origin main
git checkout -b develop
git push -u origin develop
```

### Step 8: Manual steps (user must do in dashboards)

#### 8a. Create Supabase projects

1. `caab-whatsapp-router-staging` (free tier)
2. `caab-whatsapp-router-prod` (free tier or pro)
3. Get personal access token from [supabase.com/dashboard/account/tokens](https://supabase.com/dashboard/account/tokens)

#### 8b. Configure GitHub secrets

Go to **Settings → Secrets → Actions** and add:

| Secret | Source |
|---|---|
| `SUPABASE_ACCESS_TOKEN` | Personal access token |
| `SUPABASE_DB_PASSWORD_STAGING` | Staging DB password |
| `SUPABASE_DB_PASSWORD_PRODUCTION` | Production DB password |
| `STAGING_PROJECT_ID` | Staging project ref from dashboard URL |
| `PRODUCTION_PROJECT_ID` | Production project ref from dashboard URL |

---

## Critical Files

| File | Action |
|---|---|
| `nul` | DELETE |
| `.gitignore` | EDIT — add `nul` entry |
| `.github/workflows/ci.yml` | EDIT — `supabase db start`, `workflow_dispatch` |
| `.github/workflows/staging.yml` | EDIT — concurrency, `workflow_dispatch`, env var alignment |
| `.github/workflows/production.yml` | EDIT — concurrency, `workflow_dispatch`, env var alignment |
| `src/lib/db/types.ts` | CREATE — generated baseline types |

---

## Verification

| # | Test | Expected Result |
|---|---|---|
| 1 | **Local:** `supabase db start` | Succeeds, types generate without error |
| 2 | **Push to `main`:** | `production.yml` triggers — succeeds with no migrations (no-op) |
| 3 | **Push `develop`:** | `staging.yml` triggers — succeeds with no migrations (no-op) |
| 4 | **Open PR to `develop`:** | `ci.yml` triggers — starts DB, generates types, runs `tsc` + `lint` |
| 5 | **Manual trigger:** | Click "Run workflow" in GitHub Actions UI for any workflow |
